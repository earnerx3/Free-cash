<!-- START OF FILE index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Apple & Earn</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- NEW: PDF GENERATION LIBRARIES (JSPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --bg-body: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            /* bKash Theme Color */
            --bkash-pink: #e2136e; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; font-family: 'Plus Jakarta Sans', sans-serif; }
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(circle at top right, rgba(99, 102, 241, 0.15), transparent 40%);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            padding-top: 20px;
            box-shadow: var(--shadow);
        }
        .brand {
            padding: 0 25px 25px;
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-links { list-style: none; padding: 10px; }
        .nav-item {
            padding: 14px 20px;
            margin-bottom: 5px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            border-radius: 12px;
            font-size: 0.95rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), transparent);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }
        .nav-item i { width: 22px; text-align: center; font-size: 1.1rem; }
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }
        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }
        .page-title h2 { font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; }
        .page-title p { color: var(--text-muted); font-size: 0.95rem; margin-top: 5px; }
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: rgba(99, 102, 241, 0.3); }
        .stat-card h3 { font-size: 2.2rem; margin: 10px 0 5px; font-weight: 700; color: white; }
        .stat-card p { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .stat-icon {
            position: absolute; right: 20px; top: 20px; font-size: 2.5rem; opacity: 0.1; color: white;
        }
        .table-container {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(0,0,0,0.3); }
        th, td { padding: 18px 25px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-muted); vertical-align: middle; }
        th { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; color: var(--text-main); }
        td { color: #e2e8f0; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .badge { padding: 6px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .bg-pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .bg-paid { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .bg-rejected { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .btn {
            padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
            transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn-primary:active { transform: scale(0.95); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-bkash { background: var(--bkash-pink); color: white; box-shadow: 0 4px 15px rgba(226, 19, 110, 0.4); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; }
        .form-control {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            color: white; border-radius: 12px; transition: 0.3s; font-size: 0.95rem;
        }
        .form-control:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        
        select.form-control option { background: #1e293b; color: white; }
        #toast-box {
            position: fixed; bottom: 30px; right: 30px; z-index: 2000;
        }
        .toast {
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            color: white; padding: 15px 25px; border-radius: 12px; margin-top: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); border-left: 4px solid var(--primary);
            animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px;
        }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200;
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #1e293b; width: 450px; padding: 30px; border-radius: 20px;
            border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .user-cell {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
            background: var(--bg-sidebar);
        }
        .user-avatar-sm {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }
        /* DATE INPUT STYLING */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        #loginOverlay {
            position: fixed; inset: 0; background: #0b0f19; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>
    <div id="toast-box"></div>
    <div id="loginOverlay">
        <div style="text-align: center; margin-bottom: 40px;">
            <div style="width: 80px; height: 80px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-fingerprint" style="font-size: 2.5rem; color: var(--primary);"></i>
            </div>
            <h2 style="font-size: 1.8rem; font-weight: 700;">Admin Access</h2>
            <p style="color: var(--text-muted);">Enter your secure PIN to continue</p>
        </div>
        <div style="position: relative; width: 280px;">
            <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="form-control" style="text-align: center; font-size: 1.5rem; letter-spacing: 5px; height: 60px;">
        </div>
        <button class="btn btn-primary" onclick="checkLogin()" style="margin-top: 25px; width: 280px; padding: 15px;">Unlock Panel</button>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 25px; font-size: 1.4rem;">Edit User Balance</h3>
            <input type="hidden" id="editUserId">
            
            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Task Balance ($)</label>
                <input type="number" id="editTaskBal" class="form-control" step="0.01">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Referral Balance ($)</label>
                <input type="number" id="editRefBal" class="form-control" step="0.01">
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Ads Watched Today</label>
                <input type="number" id="editAds" class="form-control">
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-primary" style="flex:1" onclick="saveUserChanges()">Save Changes</button>
                <button class="btn btn-danger" style="background:transparent; border:1px solid var(--border); flex:1" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-layer-group"></i> AdminPro
        </div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="showSection('dashboard', this)">
                <i class="fas fa-chart-pie"></i> Dashboard
            </li>
            <li class="nav-item" onclick="showSection('withdrawals', this)">
                <i class="fas fa-wallet"></i> Withdrawals
            </li>
            <li class="nav-item" onclick="showSection('users', this)">
                <i class="fas fa-users"></i> Users
            </li>
            <li class="nav-item" onclick="showSection('settings', this)">
                <i class="fas fa-sliders-h"></i> App Settings
            </li>
        </ul>
        <div style="margin-top: auto; padding: 20px;">
            <button class="btn" onclick="refreshAllData()" style="width: 100%; background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid var(--primary);">
                <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh Data
            </button>
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="section active">
            <div class="header-area">
                <div class="page-title">
                    <h2>Overview</h2>
                    <p>Welcome back, Admin</p>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users stat-icon"></i>
                    <p>Total Users</p>
                    <h3 id="statTotalUsers">0</h3>
                </div>
                <div class="stat-card">
                    <i class="fas fa-paper-plane stat-icon" style="color: var(--success);"></i>
                    <p>Total Paid Out</p>
                    <h3 id="statTotalPaid" style="color: var(--success);">$0.00</h3>
                </div>
                <div class="stat-card">
                    <i class="fas fa-hourglass-half stat-icon" style="color: var(--warning);"></i>
                    <p>Pending Requests</p>
                    <h3 id="statPendingCount" style="color: var(--warning);">0</h3>
                </div>
                <div class="stat-card">
                    <i class="fas fa-wallet stat-icon" style="color: #60a5fa;"></i>
                    <p>User Holdings</p>
                    <h3 id="statUserHoldings" style="color: #60a5fa;">$0.00</h3>
                </div>
            </div>
            <div class="glass-card">
                <h3 style="margin-bottom: 20px; font-size: 1.1rem;">Recent User Registrations</h3>
                <div class="table-container">
                    <table id="recentTable">
                        <thead><tr><th>User Info</th><th>Joined Date</th><th>Current Balance</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="withdrawals" class="section">
            <div class="header-area">
                <div class="page-title">
                    <h2>Withdrawals</h2>
                    <p>Manage pending payments</p>
                </div>
                <div id="bulkActions" style="display:none; gap:10px;">
                    <button class="btn btn-success btn-sm" onclick="bulkAction('paid')">Approve All</button>
                    <button class="btn btn-danger btn-sm" onclick="bulkAction('rejected')">Reject All</button>
                </div>
            </div>

            <!-- NEW: RECEIPT DOWNLOAD CARD -->
            <div class="glass-card" style="margin-bottom: 25px; border-left: 4px solid var(--bkash-pink);">
                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between;">
                    <div>
                        <h3 style="color: white; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-invoice-dollar" style="color: var(--bkash-pink);"></i> Download Daily Receipt
                        </h3>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">
                            Generate bKash-themed PDF for paid withdrawals on a specific date.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="date" id="receiptDate" class="form-control" style="width: auto; padding: 10px;">
                        <button class="btn btn-bkash" onclick="downloadDailyReceipt()">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table id="withdrawTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllW" onclick="toggleSelectAll()"></th>
                            <th>User Profile</th>
                            <th>Method & Number</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="users" class="section">
            <div class="header-area">
                <div class="page-title">
                    <h2>User Manager</h2>
                    <p>Search and edit user details</p>
                </div>
                <div style="position: relative; width: 300px;">
                    <i class="fas fa-search" style="position: absolute; left: 15px; top: 15px; color: var(--text-muted);"></i>
                    <input type="text" id="userSearch" class="form-control" style="padding-left: 45px;" placeholder="Search..." onkeyup="filterUsers()">
                </div>
            </div>
            <div class="table-container">
                <table id="userTable">
                    <thead>
                        <tr>
                            <th>User Profile</th>
                            <th>Task Bal</th>
                            <th>Ref Bal</th>
                            <th>Total Earned</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="header-area">
                <div class="page-title">
                    <h2>App Configuration</h2>
                    <p>Control ads, tasks, and withdrawal rules</p>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Save Changes</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                
                <div class="glass-card">
                    <h3 style="margin-bottom: 20px; color: var(--primary); font-size: 1.1rem;"><i class="fas fa-cog"></i> General</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Home Notice / Announcement</label>
                        <textarea id="cfgNotice" class="form-control" rows="3"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Ad Network Zone ID</label>
                        <input type="text" id="cfgZoneId" class="form-control">
                    </div>
                </div>

                <div class="glass-card">
                    <h3 style="margin-bottom: 20px; color: var(--success); font-size: 1.1rem;"><i class="fas fa-coins"></i> Economy</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Referral Bonus ($)</label>
                            <input type="number" id="cfgRefBonus" class="form-control" step="0.01">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Ad Reward ($)</label>
                            <input type="number" id="cfgAdReward" class="form-control" step="0.001">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Daily Ad Watch Limit</label>
                        <input type="number" id="cfgAdLimit" class="form-control">
                    </div>
                </div>

                <div class="glass-card" style="border: 1px solid #0ea5e9;">
                    <h3 style="margin-bottom: 20px; color: #0ea5e9; font-size: 1.1rem;"><i class="fas fa-shield-alt"></i> Ref Verification</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Status (Enable/Disable)</label>
                        <select id="cfgVerEnabled" class="form-control">
                            <option value="true">‚úÖ Enabled (ON)</option>
                            <option value="false">‚ùå Disabled (OFF)</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Ad / Verify Link</label>
                        <input type="text" id="cfgVerLink" class="form-control" placeholder="https://...">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Clicks Needed</label>
                            <input type="number" id="cfgVerClicks" class="form-control" placeholder="2">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Button Text</label>
                            <input type="text" id="cfgVerBtnTxt" class="form-control" placeholder="Verify Now">
                        </div>
                    </div>
                </div>

                <div class="glass-card" style="border: 1px solid var(--warning);">
                    <h3 style="margin-bottom: 20px; color: var(--warning); font-size: 1.1rem;"><i class="fas fa-hand-holding-usd"></i> Withdrawal Rules</h3>
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border);">
                        <h4 style="font-size: 0.9rem; color: #fff; margin-bottom: 10px;">For Task Balance (Main)</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Min Amount ($)</label>
                                <input type="number" id="cfgTaskMinAmt" class="form-control" placeholder="50">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Min Referrals</label>
                                <input type="number" id="cfgTaskMinRef" class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="font-size: 0.9rem; color: #fff; margin-bottom: 10px;">For Referral Balance</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Min Amount ($)</label>
                                <input type="number" id="cfgRefMinAmt" class="form-control" placeholder="100">
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:8px; color:var(--text-muted);">Min Referrals</label>
                                <input type="number" id="cfgRefMinRef" class="form-control" placeholder="5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card" style="margin-top: 25px;">
                <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Task List</h3>
                    <button class="btn btn-success btn-sm" onclick="toggleTaskInput()">+ Add Task</button>
                </div>
                
                <div id="taskInputArea" style="display:none; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; grid-template-columns: 2fr 2fr 1fr 0.5fr; gap: 10px;">
                    <input id="newTTitle" placeholder="Task Title (e.g. Watch Video)" class="form-control">
                    <input id="newTUrl" placeholder="Task URL (https://...)" class="form-control">
                    <input id="newTReward" placeholder="Reward $" type="number" class="form-control">
                    <button class="btn btn-primary" onclick="submitTask()">Add</button>
                </div>
                <div class="table-container">
                    <table id="taskTable">
                        <thead><tr><th>Title</th><th>URL</th><th>Reward</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG (YOUR KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCNz6xpNVFYhrMWb90MGqPcc4_FXVGJRjI",
            authDomain: "imo-clone-17935.firebaseapp.com",
            projectId: "imo-clone-17935",
            storageBucket: "imo-clone-17935.firebasestorage.app",
            messagingSenderId: "760912716104",
            appId: "1:760912716104:web:07aea8166ed4638f64537d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- VARIABLES ---
        let allUsers = [];
        let allWithdrawals = [];
        let selectedWithdrawalIds = [];
        let currentTasks = [];
        const ADMIN_PIN = "123456";

        // --- UTILS ---
        function showToast(msg, type='success') {
            const box = document.getElementById('toast-box');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i><span>${msg}</span>`;
            box.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getUserImage(u) {
            if(u.photoURL && u.photoURL.length > 5) return u.photoURL;
            if(u.profilePic && u.profilePic.length > 5) return u.profilePic;
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.uid || 'guest'}&backgroundColor=b6e3f4`;
        }

        // --- AUTH ---
        function checkLogin() {
            if(document.getElementById('adminPass').value === ADMIN_PIN) {
                document.getElementById('loginOverlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loginOverlay').remove(), 500);
                showToast("Logging in...", "success");
                refreshAllData();
            } else {
                showToast("Invalid PIN Access Denied", "error");
            }
        }

        function showSection(id, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- DATA LOADING ---
        async function refreshAllData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('fa-spin');
            
            try {
                // Fetch Users
                const uSnap = await db.collection('users').get();
                allUsers = [];
                let totalHoldings = 0;
                uSnap.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id; 
                    allUsers.push(d);
                    totalHoldings += (d.taskBalance || 0) + (d.referralBalance || 0);
                });

                // Fetch Withdrawals
                const wSnap = await db.collection('withdrawals').orderBy('date', 'desc').get();
                allWithdrawals = [];
                let totalPaid = 0;
                let pendingCount = 0;
                wSnap.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id;
                    allWithdrawals.push(d);
                    if(d.status === 'paid') totalPaid += (d.amount || 0);
                    if(d.status === 'pending') pendingCount++;
                });

                document.getElementById('statTotalUsers').innerText = allUsers.length;
                document.getElementById('statUserHoldings').innerText = "$" + totalHoldings.toFixed(2);
                document.getElementById('statTotalPaid').innerText = "$" + totalPaid.toFixed(2);
                document.getElementById('statPendingCount').innerText = pendingCount;

                renderRecentUsers();
                renderWithdrawals();
                renderUsers(allUsers);
                
                await loadSettings();
                showToast("All Data Updated Successfully");
            } catch (error) {
                console.error(error);
                showToast("Error loading data: " + error.message, "error");
            } finally {
                icon.classList.remove('fa-spin');
            }
        }

        // --- TABLE RENDERING HELPERS ---
        function renderRecentUsers() {
            const tbody = document.querySelector('#recentTable tbody');
            tbody.innerHTML = '';
            const recent = [...allUsers].reverse().slice(0, 6); 
            if(recent.length === 0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No users found</td></tr>';
            
            recent.forEach(u => {
                const bal = ((u.taskBalance||0) + (u.referralBalance||0)).toFixed(2);
                const img = getUserImage(u);
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <img src="${img}" class="user-avatar-sm" alt="U">
                                <div>
                                    <div style="font-weight:600">${u.name || 'User'}</div>
                                    <small style="color:#64748b">${u.uid ? u.uid.substr(0,8) : 'N/A'}...</small>
                                </div>
                            </div>
                        </td>
                        <td>${u.joinedAt ? new Date(u.joinedAt.seconds*1000).toLocaleDateString() : 'N/A'}</td>
                        <td style="color:var(--success)">$${bal}</td>
                    </tr>`;
            });
        }

        function renderWithdrawals() {
            const tbody = document.querySelector('#withdrawTable tbody');
            tbody.innerHTML = '';
            selectedWithdrawalIds = [];
            
            if(allWithdrawals.length === 0) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No withdrawals found</td></tr>';
            allWithdrawals.forEach(w => {
                const user = allUsers.find(u => u.uid === w.uid) || {name: 'Unknown', uid: w.uid};
                const img = getUserImage(user);
                const date = w.date ? new Date(w.date.seconds * 1000).toLocaleDateString() : '-';
                const statusClass = w.status === 'pending' ? 'bg-pending' : w.status === 'paid' ? 'bg-paid' : 'bg-rejected';
                const checkbox = w.status === 'pending' ? `<input type="checkbox" value="${w.id}" onchange="selectWRow(this)">` : '';
                const btns = w.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="processOne('${w.id}', 'paid')"><i class="fas fa-check"></i></button><button class="btn btn-danger btn-sm" onclick="processOne('${w.id}', 'rejected')"><i class="fas fa-times"></i></button>` : '-';
                tbody.innerHTML += `
                    <tr>
                        <td>${checkbox}</td>
                        <td>
                            <div class="user-cell">
                                <img src="${img}" class="user-avatar" alt="U">
                                <div>
                                    <div style="font-weight:600; font-size:0.9rem;">${user.name || 'User'}</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted)">ID: ${w.uid.substr(0,8)}...</div>
                                </div>
                            </div>
                        </td>
                        <td>${w.method}<br><small style="color:white; opacity:0.8">${w.account}</small></td>
                        <td style="font-weight:700;">$${w.amount} <small style="font-weight:400; color:var(--text-muted)">(${w.source})</small></td>
                        <td><span class="badge ${statusClass}">${w.status}</span></td>
                        <td>${date}</td>
                        <td><div style="display:flex; gap:5px;">${btns}</div></td>
                    </tr>`;
            });
            document.getElementById('bulkActions').style.display = 'none';
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';
            const list = users.slice(0, 50); 
            if(list.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No users found</td></tr>';
            list.forEach(u => {
                const img = getUserImage(u);
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <img src="${img}" class="user-avatar" alt="U">
                                <div>
                                    <div style="font-weight:600">${u.name || 'No Name'}</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted)">ID: ${u.uid}</div>
                                    <div style="font-size:0.75rem; color:var(--primary)">Refs: ${u.referralCount || 0}</div>
                                </div>
                            </div>
                        </td>
                        <td>$${(u.taskBalance||0).toFixed(3)}</td>
                        <td>$${(u.referralBalance||0).toFixed(3)}</td>
                        <td style="color:var(--success)">$${((u.taskBalance||0)+(u.referralBalance||0)).toFixed(2)}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="openEditModal('${u.uid}')">Edit</button></td>
                    </tr>`;
            });
        }

        // --- WITHDRAW LOGIC ---
        function toggleSelectAll() {
            const checked = document.getElementById('selectAllW').checked;
            document.querySelectorAll('#withdrawTable input[type="checkbox"]').forEach(c => {
                c.checked = checked; selectWRow(c);
            });
        }
        function selectWRow(el) {
            if(el.id === 'selectAllW') return;
            if(el.checked) { if(!selectedWithdrawalIds.includes(el.value)) selectedWithdrawalIds.push(el.value); }
            else { selectedWithdrawalIds = selectedWithdrawalIds.filter(id => id !== el.value); }
            document.getElementById('bulkActions').style.display = selectedWithdrawalIds.length > 0 ? 'flex' : 'none';
        }
        async function processOne(id, status) {
            if(!confirm(`Mark this as ${status}?`)) return;
            selectedWithdrawalIds = [id]; await bulkAction(status);
        }
        async function bulkAction(status) {
            try {
                const batch = db.batch();
                selectedWithdrawalIds.forEach(id => {
                    const ref = db.collection('withdrawals').doc(id);
                    batch.update(ref, { status: status });
                    if(status === 'rejected') {
                        const wData = allWithdrawals.find(w => w.id === id);
                        if(wData) {
                            const uRef = db.collection('users').doc(wData.uid);
                            if(wData.source === 'task') batch.update(uRef, { taskBalance: firebase.firestore.FieldValue.increment(wData.amount) });
                            else batch.update(uRef, { referralBalance: firebase.firestore.FieldValue.increment(wData.amount) });
                        }
                    }
                });
                await batch.commit();
                showToast(`${selectedWithdrawalIds.length} Requests ${status}`);
                refreshAllData();
            } catch (e) { console.error(e); showToast("Failed: " + e.message, "error"); }
        }

        // NEW: DOWNLOAD RECEIPT LOGIC (PDF)
        function downloadDailyReceipt() {
            const dateInput = document.getElementById('receiptDate').value;
            if(!dateInput) {
                showToast("Please select a date first!", "error");
                return;
            }

            // Filter data for selected date AND status='paid'
            const targetDate = new Date(dateInput).toDateString(); // e.g. "Mon Jan 01 2024"
            
            const reportData = allWithdrawals.filter(w => {
                if(w.status !== 'paid') return false;
                if(!w.date) return false;
                const wDate = new Date(w.date.seconds * 1000).toDateString();
                return wDate === targetDate;
            });

            if(reportData.length === 0) {
                showToast("No paid records found for " + dateInput, "error");
                return;
            }

            // Generate PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();

            // -- HEADER --
            // bKash Pink Background Header
            doc.setFillColor(226, 19, 110); // #E2136E
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            // White Text
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("Apple & Earn", pageWidth / 2, 20, { align: "center" }); // üçí üçé omitted for PDF stability
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text("Daily Payment Receipt", pageWidth / 2, 30, { align: "center" });
            
            doc.setFontSize(10);
            doc.text("Date: " + dateInput, pageWidth / 2, 38, { align: "center" });

            // -- SUMMARY --
            const totalAmount = reportData.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            doc.setTextColor(50, 50, 50);
            doc.setFontSize(11);
            doc.text(`Total Transactions: ${reportData.length}`, 14, 55);
            doc.text(`Total Amount Paid: $${totalAmount.toFixed(2)}`, pageWidth - 14, 55, { align: "right" });

            // -- TABLE DATA PREP --
            const tableBody = reportData.map((w, index) => {
                const user = allUsers.find(u => u.uid === w.uid) || {name: 'Unknown'};
                return [
                    index + 1,
                    user.name || "N/A",
                    w.account || "N/A", // Phone Number
                    "$" + parseFloat(w.amount).toFixed(2),
                    w.method || "Wallet",
                    "PAID"
                ];
            });

            // -- TABLE DRAWING --
            doc.autoTable({
                startY: 60,
                head: [['SL', 'User Name', 'Account / Phone', 'Amount', 'Method', 'Status']],
                body: tableBody,
                theme: 'grid',
                headStyles: {
                    fillColor: [226, 19, 110], // bKash Pink
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 15 },
                    3: { halign: 'right', fontStyle: 'bold' },
                    5: { halign: 'center', textColor: [16, 185, 129] } // Green text for PAID
                },
                styles: {
                    fontSize: 10,
                    cellPadding: 6,
                    lineColor: [220, 220, 220]
                },
                alternateRowStyles: {
                    fillColor: [255, 240, 245] // Very light pink for alternate rows
                }
            });

            // -- FOOTER --
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text("This receipt is computer generated by Apple & Earn Admin Panel.", pageWidth / 2, finalY, { align: "center" });
            doc.text("Authorized Signature ________________", pageWidth - 20, finalY + 15, { align: "right" });

            // Save File
            doc.save(`Receipt_${dateInput}.pdf`);
            showToast("Receipt Downloaded Successfully!");
        }

        // --- USER SEARCH & EDIT ---
        function filterUsers() {
            const q = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(u => (u.name && u.name.toLowerCase().includes(q)) || (u.uid && u.uid.toLowerCase().includes(q)));
            renderUsers(filtered);
        }

        function openEditModal(uid) {
            const u = allUsers.find(user => user.uid === uid);
            document.getElementById('editUserId').value = uid;
            document.getElementById('editTaskBal').value = u.taskBalance || 0;
            document.getElementById('editRefBal').value = u.referralBalance || 0;
            document.getElementById('editAds').value = u.adsWatchedToday || 0;
            document.getElementById('editUserModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('editUserModal').style.display = 'none'; }

        async function saveUserChanges() {
            try {
                const uid = document.getElementById('editUserId').value;
                await db.collection('users').doc(uid).update({
                    taskBalance: parseFloat(document.getElementById('editTaskBal').value),
                    referralBalance: parseFloat(document.getElementById('editRefBal').value),
                    adsWatchedToday: parseInt(document.getElementById('editAds').value)
                });
                closeModal(); showToast("User Updated"); refreshAllData();
            } catch(e) { showToast("Failed: " + e.message, "error"); }
        }

        // --- SETTINGS & TASKS ---
        async function loadSettings() {
            try {
                const doc = await db.collection('config').doc('appConfig').get();
                let d = doc.exists ? doc.data() : { tasks: [] };
                
                document.getElementById('cfgNotice').value = d.notice || '';
                document.getElementById('cfgZoneId').value = d.adZoneId || '';
                document.getElementById('cfgRefBonus').value = d.referralBonus || 0;
                document.getElementById('cfgAdReward').value = d.adReward || 0;
                document.getElementById('cfgAdLimit').value = d.dailyAdLimit || 0;
                
                const ver = d.verification || { enabled: false, link: '', requiredClicks: 2, btnText: 'Verify' };
                document.getElementById('cfgVerEnabled').value = ver.enabled ? "true" : "false";
                document.getElementById('cfgVerLink').value = ver.link || '';
                document.getElementById('cfgVerClicks').value = ver.requiredClicks || 2;
                document.getElementById('cfgVerBtnTxt').value = ver.btnText || '';

                const rules = d.withdrawRules || { task: { minAmount:50, minRefs:0 }, ref: { minAmount:100, minRefs:5 } };
                document.getElementById('cfgTaskMinAmt').value = rules.task ? rules.task.minAmount : 50;
                document.getElementById('cfgTaskMinRef').value = rules.task ? rules.task.minRefs : 0;
                document.getElementById('cfgRefMinAmt').value = rules.ref ? rules.ref.minAmount : 100;
                document.getElementById('cfgRefMinRef').value = rules.ref ? rules.ref.minRefs : 5;

                currentTasks = d.tasks || [];
                renderTasks();
            } catch(e) { console.error(e); }
        }

        async function saveSettings() {
            try {
                await db.collection('config').doc('appConfig').set({
                    notice: document.getElementById('cfgNotice').value,
                    adZoneId: document.getElementById('cfgZoneId').value,
                    referralBonus: parseFloat(document.getElementById('cfgRefBonus').value),
                    adReward: parseFloat(document.getElementById('cfgAdReward').value),
                    dailyAdLimit: parseInt(document.getElementById('cfgAdLimit').value),
                    verification: {
                        enabled: document.getElementById('cfgVerEnabled').value === "true",
                        link: document.getElementById('cfgVerLink').value,
                        requiredClicks: parseInt(document.getElementById('cfgVerClicks').value),
                        btnText: document.getElementById('cfgVerBtnTxt').value
                    },
                    withdrawRules: {
                        task: {
                            minAmount: parseFloat(document.getElementById('cfgTaskMinAmt').value),
                            minRefs: parseInt(document.getElementById('cfgTaskMinRef').value)
                        },
                        ref: {
                            minAmount: parseFloat(document.getElementById('cfgRefMinAmt').value),
                            minRefs: parseInt(document.getElementById('cfgRefMinRef').value)
                        }
                    },
                    tasks: currentTasks
                }, {merge: true});
                showToast("Settings Saved Successfully");
            } catch(e) { showToast("Save failed: " + e.message, "error"); }
        }

        function toggleTaskInput() {
            const area = document.getElementById('taskInputArea');
            area.style.display = area.style.display === 'none' ? 'grid' : 'none';
        }

        function submitTask() {
            const title = document.getElementById('newTTitle').value;
            const url = document.getElementById('newTUrl').value;
            const reward = document.getElementById('newTReward').value;
            
            if(title && url && reward) {
                const uniqueId = "task_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
                currentTasks.push({ 
                    id: uniqueId, 
                    title: title, 
                    url: url, 
                    reward: parseFloat(reward),
                    icon: "fas fa-play-circle" 
                });
                document.getElementById('newTTitle').value = '';
                document.getElementById('newTUrl').value = '';
                document.getElementById('newTReward').value = '';
                renderTasks();
            }
        }

        function renderTasks() {
            const tbody = document.querySelector('#taskTable tbody');
            tbody.innerHTML = '';
            if(currentTasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No tasks added</td></tr>';
                return;
            }
            currentTasks.forEach((t, i) => {
                tbody.innerHTML += `<tr><td>${t.title}</td><td><a href="${t.url}" target="_blank" style="color:var(--primary)">Link</a></td><td>$${t.reward}</td><td><button class="btn btn-danger btn-sm" onclick="removeTask(${i})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        function removeTask(i) {
            currentTasks.splice(i, 1);
            renderTasks();
        }
    </script>
</body>
</html>
